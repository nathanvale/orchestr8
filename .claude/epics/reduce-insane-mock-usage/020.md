---
name: Create automated mock count tracking in CI
status: open
created: 2025-09-20T01:15:53Z
updated: 2025-09-20T01:15:53Z
github: [Will be updated when synced to GitHub]
depends_on: [019]
parallel: true
conflicts_with: []
---

# Task 020: Create automated mock count tracking in CI

## Description

Integrate automated mock count tracking into the CI/CD pipeline to enforce mock
reduction targets, prevent regression, and maintain visibility into mock usage
trends. This ensures that mock reduction progress is sustained and that new
excessive mocking is prevented.

The CI integration will provide automated gatekeeping, trend reporting, and
enforcement of mock usage policies established during the epic execution.

## Acceptance Criteria

1. **CI Pipeline Integration**
   - [ ] Integrate mock monitoring tools into CI/CD pipeline
   - [ ] Implement automated mock count checks on every PR
   - [ ] Create failure conditions for mock threshold violations
   - [ ] Generate mock usage reports for each build

2. **Threshold Enforcement**
   - [ ] Implement configurable mock count limits
   - [ ] Enforce per-file and total mock thresholds
   - [ ] Prevent regression in mock reduction progress
   - [ ] Allow controlled threshold adjustments

3. **Reporting and Visibility**
   - [ ] Generate automated mock usage reports in CI
   - [ ] Create trend tracking across builds
   - [ ] Integrate with PR comments for immediate feedback
   - [ ] Store historical data for long-term analysis

4. **Policy Enforcement**
   - [ ] Block PRs that violate mock usage policies
   - [ ] Provide clear guidance for resolving violations
   - [ ] Implement approval workflows for threshold exceptions
   - [ ] Document enforcement policies and procedures

## Technical Details

### CI Pipeline Configuration

1. **GitHub Actions Workflow**

   ```yaml
   name: Mock Usage Monitoring

   on:
     pull_request:
       branches: [main, develop]
     push:
       branches: [main]

   jobs:
     mock-analysis:
       runs-on: ubuntu-latest

       steps:
         - name: Checkout code
           uses: actions/checkout@v4
           with:
             fetch-depth: 0 # Need full history for trend analysis

         - name: Setup Node.js
           uses: actions/setup-node@v4
           with:
             node-version: '18'
             cache: 'pnpm'

         - name: Install dependencies
           run: pnpm install

         - name: Run mock analysis
           run: |
             npx mock-monitor scan \
               --format json \
               --output mock-report.json \
               --baseline .github/mock-baseline.json

         - name: Check mock thresholds
           run: |
             npx mock-monitor check \
               --report mock-report.json \
               --config .github/mock-config.json \
               --fail-on-violation

         - name: Generate PR comment
           if: github.event_name == 'pull_request'
           uses: actions/github-script@v7
           with:
             script: |
               const fs = require('fs');
               const report = JSON.parse(fs.readFileSync('mock-report.json', 'utf8'));
               const comment = generateMockReportComment(report);

               github.rest.issues.createComment({
                 issue_number: context.issue.number,
                 owner: context.repo.owner,
                 repo: context.repo.repo,
                 body: comment
               });

         - name: Update baseline on main
           if: github.ref == 'refs/heads/main'
           run: |
             cp mock-report.json .github/mock-baseline.json
             git config --local user.email "action@github.com"
             git config --local user.name "GitHub Action"
             git add .github/mock-baseline.json
             git commit -m "chore: update mock baseline [skip ci]" || exit 0
             git push

         - name: Upload artifacts
           uses: actions/upload-artifact@v4
           with:
             name: mock-analysis-report
             path: |
               mock-report.json
               mock-report.html
   ```

2. **Mock Configuration File**
   ```json
   {
     "thresholds": {
       "global": {
         "maxTotalMocks": 1500,
         "maxAverageComplexity": 3.5,
         "maxNewMocksPerPR": 10
       },
       "perFile": {
         "maxMocks": 8,
         "maxComplexity": 6
       },
       "perCategory": {
         "external_service": 300,
         "internal_module": 100,
         "utility_function": 50,
         "console_output": 0,
         "file_system": 200
       }
     },
     "violations": {
       "failOnExceed": true,
       "allowedOverages": {
         "totalMocks": 50,
         "perFile": 2
       }
     },
     "reporting": {
       "includeTrends": true,
       "includeRecommendations": true,
       "commentOnPR": true,
       "generateHtml": true
     }
   }
   ```

### CI Integration Tools

1. **Mock Monitor CLI for CI**

   ```typescript
   export class MockMonitorCI {
     @Command('check')
     async checkThresholds(
       @Option('--report') reportPath: string,
       @Option('--config') configPath: string,
       @Option('--baseline') baselinePath?: string,
       @Option('--fail-on-violation') failOnViolation: boolean = false,
     ): Promise<void> {
       const report = await this.loadReport(reportPath)
       const config = await this.loadConfig(configPath)
       const baseline = baselinePath
         ? await this.loadBaseline(baselinePath)
         : null

       const violations = await this.analyzeViolations(report, config, baseline)

       if (violations.length > 0) {
         console.log('ðŸš¨ Mock usage violations detected:')
         violations.forEach((violation) => {
           console.log(`  ${violation.severity}: ${violation.message}`)
         })

         if (failOnViolation) {
           process.exit(1)
         }
       } else {
         console.log('âœ… All mock usage checks passed')
       }

       // Set GitHub Actions outputs
       this.setGitHubOutput('violations-count', violations.length)
       this.setGitHubOutput('total-mocks', report.summary.totalMocks)
       this.setGitHubOutput(
         'mock-reduction',
         this.calculateReduction(report, baseline),
       )
     }

     @Command('diff')
     async diffWithBaseline(
       @Option('--current') currentPath: string,
       @Option('--baseline') baselinePath: string,
       @Option('--format') format: 'text' | 'json' | 'markdown' = 'text',
     ): Promise<void> {
       const current = await this.loadReport(currentPath)
       const baseline = await this.loadReport(baselinePath)

       const diff = this.calculateDiff(current, baseline)
       const output = this.formatDiff(diff, format)

       console.log(output)

       // Set outputs for GitHub Actions
       this.setGitHubOutput('mock-change', diff.totalChange)
       this.setGitHubOutput('files-changed', diff.filesChanged.length)
     }
   }
   ```

2. **PR Comment Generator**

   ````typescript
   export class PRCommentGenerator {
     generateMockReportComment(
       report: MockReport,
       baseline?: MockReport,
     ): string {
       const diff = baseline ? this.calculateDiff(report, baseline) : null

       let comment = '## ðŸ” Mock Usage Analysis\n\n'

       // Summary section
       comment += '### Summary\n'
       comment += `- **Total Mocks**: ${report.summary.totalMocks}`
       if (diff) {
         const change = diff.totalChange
         const emoji = change > 0 ? 'ðŸ“ˆ' : change < 0 ? 'ðŸ“‰' : 'âž¡ï¸'
         comment += ` (${emoji} ${change > 0 ? '+' : ''}${change})`
       }
       comment += '\n'
       comment += `- **Average Complexity**: ${report.summary.averageComplexity.toFixed(2)}\n`
       comment += `- **Files with Mocks**: ${report.summary.totalFiles}\n\n`

       // Violations section
       if (report.alerts.length > 0) {
         comment += '### âš ï¸ Threshold Violations\n'
         report.alerts.forEach((alert) => {
           comment += `- **${alert.severity}**: ${alert.message}\n`
         })
         comment += '\n'
       }

       // Top files section
       if (report.breakdown.byFile.length > 0) {
         comment += '### ðŸ“Š Top Files by Mock Count\n'
         comment += '| File | Mocks | Complexity | Status |\n'
         comment += '|------|-------|------------|--------|\n'

         report.breakdown.byFile.slice(0, 5).forEach((file) => {
           const status =
             file.mockCount > 8 ? 'ðŸš¨' : file.mockCount > 5 ? 'âš ï¸' : 'âœ…'
           comment += `| \`${file.path}\` | ${file.mockCount} | ${file.averageComplexity.toFixed(1)} | ${status} |\n`
         })
         comment += '\n'
       }

       // Recommendations section
       if (report.recommendations.length > 0) {
         comment += '### ðŸ’¡ Recommendations\n'
         report.recommendations.forEach((rec) => {
           comment += `- ${rec}\n`
         })
         comment += '\n'
       }

       // Progress section
       if (diff) {
         comment += '### ðŸ“ˆ Progress Tracking\n'
         const reductionTarget = 1000 // From epic goals
         const currentReduction = 2000 - report.summary.totalMocks
         const progressPercentage = (currentReduction / reductionTarget) * 100

         comment += `**Epic Progress**: ${progressPercentage.toFixed(1)}% complete\n`
         comment += `**Mocks Reduced**: ${currentReduction}/${reductionTarget}\n`
         comment += `**Remaining**: ${reductionTarget - currentReduction} mocks\n\n`
       }

       comment += '<details>\n'
       comment += '<summary>ðŸ“‹ Detailed Report</summary>\n\n'
       comment += '```json\n'
       comment += JSON.stringify(report.breakdown, null, 2)
       comment += '\n```\n'
       comment += '</details>\n'

       return comment
     }
   }
   ````

### Enforcement Policies

1. **Threshold Configuration**

   ```typescript
   export interface ThresholdConfig {
     // Global thresholds
     maxTotalMocks: number
     maxAverageComplexity: number
     maxNewMocksPerPR: number

     // Per-file thresholds
     perFile: {
       maxMocks: number
       maxComplexity: number
     }

     // Category-specific thresholds
     perCategory: Record<MockCategory, number>

     // Violation handling
     violations: {
       failOnExceed: boolean
       allowedOverages: {
         totalMocks: number
         perFile: number
       }
       requireApproval: boolean
     }
   }
   ```

2. **Approval Workflow**

   ```yaml
   # .github/workflows/mock-approval.yml
   name: Mock Threshold Approval

   on:
     pull_request:
       types: [labeled]

   jobs:
     approve-mock-increase:
       if: contains(github.event.label.name, 'mock-threshold-exception')
       runs-on: ubuntu-latest

       steps:
         - name: Check approval authority
           uses: actions/github-script@v7
           with:
             script: |
               const approvers = ['tech-lead', 'architect', 'senior-dev'];
               const actor = context.actor;

               if (!approvers.includes(actor)) {
                 throw new Error(`@${actor} is not authorized to approve mock threshold exceptions`);
               }

         - name: Update threshold temporarily
           run: |
             # Allow increased threshold for this PR
             echo "Mock threshold exception approved by ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
   ```

### Historical Data Management

1. **Trend Storage**

   ```typescript
   export class MockTrendStorage {
     async storeBuildData(buildData: BuildMockData): Promise<void> {
       await this.database.buildMetrics.insert({
         buildId: buildData.buildId,
         branch: buildData.branch,
         commit: buildData.commit,
         timestamp: new Date(),
         metrics: {
           totalMocks: buildData.totalMocks,
           averageComplexity: buildData.averageComplexity,
           categoryBreakdown: buildData.categoryBreakdown,
           fileCount: buildData.fileCount,
         },
       })
     }

     async getTrend(branch: string, days: number): Promise<MockTrend> {
       const data = await this.database.buildMetrics.findByBranch(branch, days)
       return this.calculateTrend(data)
     }
   }
   ```

## Dependencies

- **Task 019**: Mock monitoring tools must be implemented first
- **Parallel Execution**: Safe for parallel execution as it's CI configuration

## Effort Estimate

**Size**: Small (1 day)

**Breakdown**:

- Day 1: Implement CI integration, configure thresholds, and test workflow

**Skills Required**:

- CI/CD pipeline expertise (GitHub Actions)
- Mock monitoring tool integration
- Configuration management
- Git workflow understanding

## Definition of Done

1. **Complete CI Integration**
   - Mock analysis integrated into all PR checks
   - Automated threshold enforcement
   - Failure conditions for policy violations
   - Historical data collection and storage

2. **Threshold Enforcement**
   - Configurable mock count and complexity limits
   - Per-file and global threshold checking
   - Category-specific enforcement
   - Controlled exception handling

3. **Automated Reporting**
   - PR comments with mock usage analysis
   - Trend tracking across builds
   - Violation alerts and recommendations
   - Historical data visualization

4. **Policy Framework**
   - Clear enforcement policies documented
   - Approval workflows for exceptions
   - Team guidelines for threshold management
   - Escalation procedures for violations

5. **Monitoring and Alerting**
   - Real-time mock usage monitoring
   - Automated alerts for policy violations
   - Integration with team communication tools
   - Dashboard for long-term trend analysis

The implementation must ensure that mock reduction progress is sustained and
that the team has clear visibility into mock usage patterns, preventing
regression while enabling continuous improvement.
