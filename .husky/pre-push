#!/usr/bin/env sh
set -eu

# Skip pre-push in CI environments
if [ "${CI:-}" = "true" ]; then
  echo "â­ï¸ Skipping pre-push validation in CI environment"
  exit 0
fi

echo "ğŸ” Running pre-push validation..."
echo "â±ï¸ This includes linting, typechecking, testing, and changeset validation"
echo "ğŸ’¡ Tip: Use 'git push --no-verify' to bypass in emergencies"

BRANCH=$(git branch --show-current)
echo "ğŸ“ Validating branch: $BRANCH"

# Use centralized base detection logic
. scripts/compute-base.sh

# Branch-aware changeset validation
if [ "$BRANCH" != "main" ] && [ "$BRANCH" != "develop" ]; then
  # Only enforce changesets when actual source code or package config changed
  CHANGED_CODE_COUNT=$(git diff --name-only "$BASE"...HEAD 2>/dev/null | grep -E '^(packages|apps)/.+/(src/.+\.(ts|tsx|js|jsx)|package\.json)$' | wc -l | tr -d '[:space:]' || echo 0)
  if [ "${CHANGED_CODE_COUNT:-0}" -gt 0 ]; then
    NEW_CHANGESETS=$(git diff --name-only "$BASE"...HEAD -- .changeset/*.md 2>/dev/null | wc -l | tr -d '[:space:]')
    if [ "${NEW_CHANGESETS:-0}" -eq 0 ]; then
      echo "âš ï¸  No new changeset added on feature branch '$BRANCH'"
      echo "ğŸ’¡ This branch modifies code but doesn't include a changeset"
      echo "ğŸ”§ Generate one with: pnpm changeset"
      echo "ğŸš€ Or bypass with: git push --no-verify"
      exit 1
    else
      echo "âœ… New changeset found (${NEW_CHANGESETS} files)"
    fi
  else
    echo "â„¹ï¸ Code changeset enforcement skipped (no TS/JS/JSON changes since base)"
  fi
fi

# Use changed-only validation for feature branches, full validation for main/develop
if [ "$BRANCH" = "main" ] || [ "$BRANCH" = "develop" ]; then
  echo "ğŸ§ª Running full validation suite for $BRANCH (build/lint/test)..."
  pnpm dlx turbo run build lint test --output-logs=errors-only

  echo "ğŸ” Running typecheck..."
  pnpm dlx turbo run typecheck --output-logs=errors-only
else
  echo "ğŸ§ª Running changed-only validation for feature branch (build/lint/test)..."
  pnpm dlx turbo run build lint test --filter="...[${TURBO_SCM_BASE:-origin/main}]" --output-logs=errors-only

  echo "ğŸ” Running changed-only typecheck..."
  pnpm dlx turbo run typecheck --filter="...[${TURBO_SCM_BASE:-origin/main}]" --output-logs=errors-only
fi

echo "ğŸ‰ All validations passed! Ready to push."
