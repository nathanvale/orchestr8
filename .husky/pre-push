#!/usr/bin/env sh
. "$(dirname "$0")/_/husky.sh"

echo "ğŸ” Running pre-push validation..."
echo "â±ï¸ This includes linting, typechecking, testing, and changeset validation"
echo "ğŸ’¡ Tip: Use 'git push --no-verify' to bypass in emergencies"

BRANCH=$(git branch --show-current)
echo "ğŸ“ Validating branch: $BRANCH"

# Branch-aware changeset validation
if [ "$BRANCH" != "main" ] && [ "$BRANCH" != "develop" ]; then
  if [ -d .changeset ]; then
    CHANGESET_COUNT=$(find .changeset -name "*.md" -not -name "README.md" | wc -l)
  else
    CHANGESET_COUNT=0
  fi
  if [ "$CHANGESET_COUNT" -eq 0 ]; then
    echo "âš ï¸  No changeset found on feature branch '$BRANCH'"
    echo "ğŸ’¡ Generate one with: pnpm changeset"
    echo "ğŸš€ Or bypass with: git push --no-verify"
    exit 1
  else
    echo "âœ… Changeset found ($CHANGESET_COUNT files)"
  fi
fi

# Use changed-only validation for feature branches, full validation for main/develop
if [ "$BRANCH" = "main" ] || [ "$BRANCH" = "develop" ]; then
  echo "ğŸ§ª Running full validation suite for $BRANCH..."
  pnpm run validate
else
  echo "ğŸ§ª Running changed-only validation for feature branch..."
  pnpm run validate:changed
fi

if [ $? -eq 0 ]; then
  echo "ğŸ‰ All validations passed! Ready to push."
else
  echo "âŒ Validation failed"
  echo "ğŸ”§ Fix issues above or bypass with: git push --no-verify"
  exit 1
fi
